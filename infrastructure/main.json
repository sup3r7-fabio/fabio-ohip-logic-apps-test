{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.33.93.31351",
      "templateHash": "9127553290200464712"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "ohipdemo",
      "metadata": {
        "description": "Prefix for generated names"
      }
    },
    "nameSuffix": {
      "type": "string",
      "defaultValue": "fabio",
      "metadata": {
        "description": "Prefix for generated names"
      }
    }
  },
  "variables": {
    "$fxv#0": "{\r\n  \"$schema\": \"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#\",\r\n  \"contentVersion\": \"1.0.0.0\",\r\n  \"parameters\": {},\r\n  \"triggers\": {\r\n    \"When_a_message_is_received_in_a_topic_subscription\": {\r\n      \"type\": \"ApiConnection\",\r\n      \"inputs\": {\r\n        \"host\": {\r\n          \"connection\": {\r\n            \"name\": \"@parameters('$connections')['servicebus']['connectionId']\"\r\n          }\r\n        },\r\n        \"path\": \"/topics/bookings/subscriptions/processing-sub/messages\",\r\n        \"method\": \"get\"\r\n      }\r\n    }\r\n  },\r\n  \"actions\": {\r\n    \"Parse_JSON\": {\r\n      \"type\": \"ParseJson\",\r\n      \"inputs\": {\r\n        \"content\": \"@triggerBody()\",\r\n        \"schema\": {\r\n          \"type\": \"object\",\r\n          \"properties\": {\r\n            \"bookingId\": { \"type\": \"string\" },\r\n            \"guestName\": { \"type\": \"string\" }\r\n          }\r\n        }\r\n      },\r\n      \"runAfter\": {}\r\n    },\r\n    \"Log_Booking\": {\r\n      \"type\": \"Http\",\r\n      \"inputs\": {\r\n        \"method\": \"POST\",\r\n        \"uri\": \"https://httpbin.org/post\",\r\n        \"body\": \"@body('Parse_JSON')\"\r\n      },\r\n      \"runAfter\": {\r\n        \"Parse_JSON\": [\r\n          \"Succeeded\"\r\n        ]\r\n      }\r\n    }\r\n  },\r\n  \"outputs\": {}\r\n}\r\n",
    "logicAppDefinition": "[json(variables('$fxv#0'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[toLower(format('{0}st{1}', parameters('namePrefix'), uniqueString(resourceGroup().id)))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot"
      }
    },
    {
      "type": "Microsoft.ServiceBus/namespaces",
      "apiVersion": "2021-11-01",
      "name": "[toLower(format('{0}-sb-{1}', parameters('namePrefix'), parameters('nameSuffix')))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard",
        "tier": "Standard"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.ServiceBus/namespaces/topics",
      "apiVersion": "2021-11-01",
      "name": "[format('{0}/{1}', toLower(format('{0}-sb-{1}', parameters('namePrefix'), parameters('nameSuffix'))), 'bookings')]",
      "properties": {
        "defaultMessageTimeToLive": "P7D"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ServiceBus/namespaces', toLower(format('{0}-sb-{1}', parameters('namePrefix'), parameters('nameSuffix'))))]"
      ]
    },
    {
      "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
      "apiVersion": "2021-11-01",
      "name": "[format('{0}/{1}/{2}', toLower(format('{0}-sb-{1}', parameters('namePrefix'), parameters('nameSuffix'))), 'bookings', 'processing-sub')]",
      "properties": {
        "lockDuration": "PT1M",
        "maxDeliveryCount": 5
      },
      "dependsOn": [
        "[resourceId('Microsoft.ServiceBus/namespaces/topics', toLower(format('{0}-sb-{1}', parameters('namePrefix'), parameters('nameSuffix'))), 'bookings')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories",
      "apiVersion": "2018-06-01",
      "name": "[toLower(format('{0}-df', parameters('namePrefix')))]",
      "location": "[parameters('location')]",
      "properties": {}
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[toLower(format('{0}-logic', parameters('namePrefix')))]",
      "location": "[parameters('location')]",
      "properties": {
        "definition": "[variables('logicAppDefinition')]"
      }
    }
  ],
  "outputs": {
    "storageAccountName": {
      "type": "string",
      "value": "[toLower(format('{0}st{1}', parameters('namePrefix'), uniqueString(resourceGroup().id)))]"
    },
    "serviceBusNamespaceName": {
      "type": "string",
      "value": "[toLower(format('{0}-sb-{1}', parameters('namePrefix'), parameters('nameSuffix')))]"
    },
    "dataFactoryName": {
      "type": "string",
      "value": "[toLower(format('{0}-df', parameters('namePrefix')))]"
    },
    "logicAppName": {
      "type": "string",
      "value": "[toLower(format('{0}-logic', parameters('namePrefix')))]"
    }
  }
}
